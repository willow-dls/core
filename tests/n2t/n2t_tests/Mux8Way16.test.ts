import { beforeAll, test, expect } from "@jest/globals";
import { Circuit, loadCircuit } from "../../../src";
import { Nand2TetrisLoader } from "../../../src/CircuitLoader/Nand2TetrisLoader";

let circuit: Circuit;

beforeAll(async () => {
  circuit = await loadCircuit(
    Nand2TetrisLoader,
    "tests/n2t/nand_up_chips/Mux8Way16.hdl",
    "Mux8Way16",
  );
});

const truthTable = [
  ["0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "0000000000000000", "000", "0000000000000000"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "000", "0001001000110100"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "001", "0010001101000101"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "010", "0011010001010110"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "011", "0100010101100111"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "100", "0101011010001000"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "101", "0110011110101001"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "110", "0111100010111010"],
  ["0001001000110100", "0010001101000101", "0011010001010110", "0100010101100111", "0101011010001000", "0110011110101001", "0111100010111010", "1000100111001011", "111", "1000100111001011"],
];

function genTest(
  inputs: { a: string; b: string; c: string; d: string; e: string; f: string; g: string; h: string; sel: string },
  output: string
) {
  return () => {
    const actualOutputs = circuit.run(inputs).outputs;
    expect(actualOutputs.out.toString()).toStrictEqual(output);
  };
}

for (const row of truthTable) {
  const inputs = {
    a: row[0],
    b: row[1],
    c: row[2],
    d: row[3],
    e: row[4],
    f: row[5],
    g: row[6],
    h: row[7],
    sel: row[8],
  };
  const output = row[9];

  test(
    `N2T Mux8Way16 [sel = ${inputs.sel}] => [out = ${output}]`,
    genTest(inputs, output),
  );
}
